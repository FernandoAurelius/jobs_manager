name: Django CD

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      # Code Checkout
      - name: Checkout Repository
        uses: actions/checkout@v4

      # SSH Configuration and EC2 Deploy
      - name: Set up SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Debug All Variables
        run: |
          echo "SCHEDULER_HOST: ${{ vars.SCHEDULER_HOST }}"
          echo "FRONTEND_HOST: ${{ vars.FRONTEND_HOST }}"
          echo "AWS_USER: ${{ vars.AWS_USER }}"
          echo "PROJECT_PATH: ${{ vars.PROJECT_PATH }}"

      - name: Deploy to Scheduler Machine
        env:
            SCHEDULER_HOST: ${{ vars.SCHEDULER_HOST }}
            AWS_USER: ${{ vars.AWS_USER }}
            PROJECT_PATH: ${{ vars.PROJECT_PATH }}
        run: |
            echo "Deploying to Scheduler Machine: $SCHEDULER_HOST"

            if ssh -T -o StrictHostKeyChecking=no -o ConnectTimeout=10 $AWS_USER@$SCHEDULER_HOST "$PROJECT_PATH/scripts/deploy_machine.sh main scheduler"; then
              echo "Scheduler machine deployment successful"
            else
              echo "Scheduler machine deployment failed"
              exit 1
            fi

      - name: Deploy to Frontend/Backend Machine
        continue-on-error: true
        env:
            FRONTEND_HOST: ${{ vars.FRONTEND_HOST }}
            AWS_USER: ${{ vars.AWS_USER }}
            PROJECT_PATH: ${{ vars.PROJECT_PATH }}
        run: |
            echo "Deploying to Frontend/Backend Machine: $FRONTEND_HOST"

            if ssh -T -o StrictHostKeyChecking=no -o ConnectTimeout=10 $AWS_USER@$FRONTEND_HOST "$PROJECT_PATH/scripts/deploy_machine.sh main frontend"; then
              echo "Frontend/Backend machine deployment successful"
            else
              echo "Frontend/Backend machine deployment failed or machine offline"
              exit 1
            fi

      - name: Deployment Summary
        run: |
          echo "Deployment Summary:"
          echo "- Scheduler machine: Required"
          echo "- Frontend/Backend machine: Optional (may be offline)"
